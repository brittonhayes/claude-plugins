#!/bin/bash
# Record quiz results for Context Compactor

set -e

RESULT=$1
TOPIC=$2

if [ -z "$RESULT" ] || [ -z "$TOPIC" ]; then
    echo "Usage: record <success|partial|failure> \"<topic>\""
    exit 1
fi

DATA_FILE="context-compactor/data/session.json"

# Create data file if it doesn't exist
if [ ! -f "$DATA_FILE" ]; then
    echo '{"quizzes": [], "stats": {"total": 0, "success": 0, "partial": 0, "failure": 0}}' > "$DATA_FILE"
fi

# Get current timestamp
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# Add quiz result using jq
jq --arg result "$RESULT" \
   --arg topic "$TOPIC" \
   --arg timestamp "$TIMESTAMP" \
   '.quizzes += [{result: $result, topic: $topic, timestamp: $timestamp}] |
    .stats.total += 1 |
    .stats[$result] += 1' \
   "$DATA_FILE" > "${DATA_FILE}.tmp"

mv "${DATA_FILE}.tmp" "$DATA_FILE"

echo "Recorded $RESULT for: $TOPIC"
